# Exercise 3: Connect to Database Securely using Identity

### Estimated Duration: 60 minutes

## Lab Scenario

Your team is now running a first version of the spring-petclinic microservice application in Azure. However you donâ€™t like the fact that your application secrets live directly in configuration code. You would like to have a better way to protect application secrets like your database connection string . In this exercise you will better protect your application secrets.

## Lab Objectives

After you complete this lab, you will be able to:

 - Create a database administrator account
 - Create service connections from the microservices to the database server
 - Update the applications to use passwordless connectivity

## Task 1: Create a database administrator account

In this task, you will perform the steps to create a database administrator account by assigning a user-assigned managed identity to your MySQL server. Additionally, you will configure the current logged-in user as the database administrator using Azure CLI commands.

1. Navigate back to **Git Bash** terminal, run the following command because You will need to allow the user assigned managed identity access to the database. To configure this, you will need to first make your current logged in user account database administrator. For this to work on a MySQL database you first need an additional managed identity.

   ```
   DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME=uid-dbadmin-petclinic-<inject key="DeploymentID" enableCopy="false" />
   
   ADMIN_IDENTITY_RESOURCE_ID=$(az identity create \
    --name $DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME \
    --resource-group $RESOURCE_GROUP \
    --query id \
    --output tsv)
   ```

1. Now you have to assign this identity to your **MySQL Server**.

   ```
   az mysql flexible-server identity assign \
      --resource-group $RESOURCE_GROUP \
      --server-name $MYSQL_SERVER_NAME \
      --identity    $DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME


   az mysql flexible-server identity list \
      --resource-group $RESOURCE_GROUP \
      --server-name $MYSQL_SERVER_NAME 
   ```

1. Get the current logged in user and object ID by running this command. This will give you the info of the user account you are currently logged in with in the Azure CLI.

   ```
   CURRENT_USER=$(az account show --query user.name --output tsv)
   echo $CURRENT_USER
   CURRENT_USER_OBJECTID=$(az ad signed-in-user show --query id --output tsv)
   echo $CURRENT_USER_OBJECTID
   ```

1. Next you create a database administrator based on your current user account by running the below command block.

   ```
   DATABASE_NAME=petclinic

   MSYS_NO_PATHCONV=1 az mysql flexible-server ad-admin create \
      --resource-group $RESOURCE_GROUP \
      --server-name $MYSQL_SERVER_NAME \
      --object-id $CURRENT_USER_OBJECTID \
      --display-name $CURRENT_USER \
      --identity $DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME

   DB_ID=$(az mysql flexible-server db show \
       --server-name $MYSQL_SERVER_NAME \
       --resource-group $RESOURCE_GROUP \
       -d $DATABASE_NAME \
       --query id \
       -o tsv)
   ```

## Task 2: Create service connections from the microservices to the database server

In this task, you will configure service connectors for Spring Petclinic microservices (customers, vets, and visits) to connect to the MySQL Flexible server. This will involve creating and validating service connections, setting up environment variables, and enabling passwordless connectivity using managed identity in Azure.

The apps deployed as the Spring Petclinic microservices will now connect using a service connector to the MySQL Flexible server. A service connector will set up the needed environment variables the service needs to make the connection. You can use the following guidance to create a service connector.

1. For creating a service connector you will need to add the serviceconnector-passwordless extension.

   ```
   az extension add --name serviceconnector-passwordless --upgrade
   ```

1. You will need your `subscription ID` and `resources IDs` to create service conections. Run the following commands to get this.

   ```
   SUBID=$(az account show --query id -o tsv)

   CUSTOMERS_ID=$(az containerapp show \
                 --resource-group $RESOURCE_GROUP \
                 --name customers-service \
                 --query id \
                 -o tsv)

    VISITS_ID=$(az containerapp show \
                --resource-group $RESOURCE_GROUP \
                --name visits-service \
                --query id \
                -o tsv)
    
    VETS_ID=$(az containerapp show \
              --resource-group $RESOURCE_GROUP \
              --name vets-service \
              --query id \
              -o tsv)
   ```

1. Create the service connection for the `customers-service`.

   ```
   CLIENT_ID=$(az identity show --resource-group $RESOURCE_GROUP --name $ACA_IDENTITY --query 'clientId' --output tsv)
   echo $CLIENT_ID

   MSYS_NO_PATHCONV=1 az containerapp connection create mysql-flexible \
      --connection mysql_conn \
      --source-id $CUSTOMERS_ID \
      --target-id $DB_ID \
      --client-type SpringBoot \
      --user-identity client-id=$CLIENT_ID  subs-id=$SUBID mysql-identity-id=$ADMIN_IDENTITY_RESOURCE_ID \
      -c customers-service
   ```

1. Now that you have created the service connection, its time to validate the connection.

   ```
   CUSTOMERS_CONN_ID=$(az containerapp connection list \
                --resource-group $RESOURCE_GROUP \
                --name customers-service \
                --query [].id -o tsv)
   
   az containerapp connection validate \
       --id $CUSTOMERS_CONN_ID
   ```
   
   ![](./media/ex3img8.png)

   >**Note:** The output of this command should show that the connection was made **successful**.

1. In the same way create the service connections for the `vets-service` and `visits-service`. and validate them.

   * vets-service
   
   ```
   MSYS_NO_PATHCONV=1 az containerapp connection create mysql-flexible \
      --connection mysql_conn \
      --source-id $VETS_ID \
      --target-id $DB_ID \
      --client-type SpringBoot \
      --user-identity client-id=$CLIENT_ID  subs-id=$SUBID mysql-identity-id=$ADMIN_IDENTITY_RESOURCE_ID \
      -c vets-service
   ```
   ```
   VETS_CONN_ID=$(az containerapp connection list \
                --resource-group $RESOURCE_GROUP \
                --name vets-service \
                --query [].id -o tsv)
   
   az containerapp connection validate \
       --id $VETS_CONN_ID
   ```
   * visits-service

   ```
   MSYS_NO_PATHCONV=1 az containerapp connection create mysql-flexible \
      --connection mysql_conn \
      --source-id $VISITS_ID \
      --target-id $DB_ID \
      --client-type SpringBoot \
      --user-identity client-id=$CLIENT_ID  subs-id=$SUBID mysql-identity-id=$ADMIN_IDENTITY_RESOURCE_ID \
      -c visits-service
   ```
   ```
   VISITS_CONN_ID=$(az containerapp connection list \
                --resource-group $RESOURCE_GROUP \
                --name visits-service \
                --query [].id -o tsv)
   
   az containerapp connection validate \
      --id $VISITS_CONN_ID
   ```

   ![](./media/ex3img9.png)

   >**Note:** The output of this command should show that the connection was made **successful**.

1. In the Azure Portal, navigate to your **customers-service** container app.

   ![](./media/ex3img10.png)

1. In the customers-service app, select the **Service Connector (1)** from left menu. Notice that you have connection named **DB for MySQL flexible server (2)**.

   ![](./media/ex3img11.png)

1. Notice that the service connector has all the config values set like `spring.datasource.url`, `spring.datasource.username`, but for instance no `spring.datasource.password`.Instead of spring.datasource.password it has a `spring.cloud.azure.credential.client-id`, which is the client ID of your managed identity. It also defines 2 additional variables `spring.datasource.azure.passwordless-enabled` and `spring.cloud.azure.credential.managed-identity-enabled` for enabling the passwordless connectivity.

   ![](./media/ex3img12.png)

## Task 3: Update the applications to use passwordless connectivity

In this task, you will update the Spring Petclinic microservices (customers, vets, and visits) to utilize passwordless connectivity with Azure. This involves modifying the pom.xml files to include the necessary dependencies, configuring the Git repository in Azure for the Java component, and redeploying the container apps to ensure they can connect to the MySQL Flexible server without credentials.

1. You will now need to update the spring-petclinic-customers-service, spring-petclinic-visits-service and spring-petclinic-vets-service to make use of the passwordless capabilities of the Azure SDK.

1. Navigate to `C:\Labfiles\aca\java-microservices-aca-lab-main\src\spring-petclinic-customers-service` and select the `pom.xml` file.

   ![](./media/ex3img1.png)

1. In the file, find **Dependency** block with `mysql-connector-j`, which looks like this:

   ![](./media/ex3img3.png)

1. Now replace the block with the below given content.

   ```
   <dependency>
       <groupId>com.azure.spring</groupId>
       <artifactId>spring-cloud-azure-starter-jdbc-mysql</artifactId>
   </dependency>
   ```

   ![](./media/ex3img2.png)
   
   >**Note:** Make sure you are providing the proper indentations as shown in the screenshot above.

1. Once the modification is done, save the file using **save** option from file menu.

   ![](./media/ex3img7.png)

1. Repeat the steps from 2 to 5 for `spring-petclinic-visits-service` and `spring-petclinic-vets-service`, by navigating to their respective directories as follows:

   |Service Name | File Path |
   |-------------|-----------|
   | visits-service | C:\Labfiles\aca\java-microservices-aca-lab-main\src\spring-petclinic-visits-service\pom.xml |
   | vets service | C:\Labfiles\aca\java-microservices-aca-lab-main\src\spring-petclinic-vets-service\pom.xml |

1. After modifying these, navigate to the **src (1)** folder and select the `pom.xml` **(2)** file.

   ![](./media/ex3img4.png)

1. In this `pom.xml` file, find the `<dependencyManagement><dependencies></dependencies></dependencyManagement>` block and add the new dependency given here.

   ```
   <dependency>
        <groupId>com.azure.spring</groupId>
        <artifactId>spring-cloud-azure-dependencies</artifactId>
        <version>${version.spring.cloud.azure}</version>
        <type>pom</type>
        <scope>import</scope>
   </dependency>
   ```
   ![](./media/ex3img5.png)

1. In the same file also add an additional property between the `<properties></properties>` block.

   ```
   <version.spring.cloud.azure>5.13.0</version.spring.cloud.azure>
   ```

   ![](./media/ex3img6.png)

1. With these changes done. Make sure you save the file using the **save** option from file menu.

   ![](./media/ex3img7.png)

1. Once all the things are done, you have to rebuild the project by running the below commands. Make sure you are in `src` directory.

   ```
   mvn clean package -DskipTests
   ```

1. In the config repository there will be no credentials, you may use the config files saved in the source code repository. You have to update the **Git Repository URL** in your **Java component** from **Config repository** to **Main repository** which contains source code.

1. In the Azure Portal, navigate to your **Container App Environment**, select **Services (1)** from left menu and click on **myconfigserver (2)** java component from the list.

   ![](./media/ex3img13.png)

1. On **Configure Java component** page, select the previous **Git Configuration (1)** and click on **Delete (2)**.

   ![](./media/ex3img14.png)

1. After the configuration is deleted, click on **Add** and provide the following details:

   - **Type** : Leave as `Default` **(1)**.
   - **URI** : Provide code repository URI which looks similarto this `https://github.com/<username>/java-microservices-aca-lab.git` **(2)** . Make sure you replace `<username>` with your GitHub Username.
   - **Branch name** : `main` **(3)**.
   - **Search paths** : `config` **(4)**.
   - **Authentication** : Select **HTTP Basic (5)** from the drop down.
   - **Username** : Provide your **GitHub Username (6)**.
   - **Password** : Provide **Personal Access Token (7)** that you have copied earlier.
   - Verify the details provided and click on **Add (8)**.
   
     ![](./media/ex3img15.png)

1. In **Configure Java component** page, scroll down and click on **Next** 

   ![](./media/ex3img16.png)

1. Review your configurations and click on configure.

1. Once the component is updated successfully, now navigate back to the **Git Bash** terminal to update the `customers-service`, `vets-service` and `visits-service` container apps by running the following commands.

   * customers-service

   ```
   cd staging-acr

   export APP_NAME="customers-service"
   cp ../spring-petclinic-$APP_NAME/target/spring-petclinic-$APP_NAME-$VERSION.jar spring-petclinic-$APP_NAME-$VERSION.jar
   sed -i "s|my-service|$APP_NAME|g" Dockerfile

   az containerapp update \
      --name $APP_NAME \
      --resource-group $RESOURCE_GROUP \
      --source .  \
      --set-env-vars APPLICATIONINSIGHTS_CONNECTION_STRING=$AI_CONNECTIONSTRING APPLICATIONINSIGHTS_CONFIGURATION_CONTENT='{"role": {"name": "customers-service"}}' InstrumentationKey=$AI_CONNECTIONSTRING

   sed -i "s|$APP_NAME|my-service|g" Dockerfile
   rm spring-petclinic-$APP_NAME-$VERSION.jar
   ```

   * vets-service

   ```
   export APP_NAME="vets-service"
   cp ../spring-petclinic-$APP_NAME/target/spring-petclinic-$APP_NAME-$VERSION.jar spring-petclinic-$APP_NAME-$VERSION.jar
   sed -i "s|my-service|$APP_NAME|g" Dockerfile
   
   az containerapp update \
      --name $APP_NAME \
      --resource-group $RESOURCE_GROUP \
      --source .  \
      --set-env-vars APPLICATIONINSIGHTS_CONNECTION_STRING=$AI_CONNECTIONSTRING APPLICATIONINSIGHTS_CONFIGURATION_CONTENT='{"role": {"name": "vets-service"}}' InstrumentationKey=$AI_CONNECTIONSTRING

   sed -i "s|$APP_NAME|my-service|g" Dockerfile
   rm spring-petclinic-$APP_NAME-$VERSION.jar
   ```

   * visits-service

   ```
   export APP_NAME="visits-service"
   cp ../spring-petclinic-$APP_NAME/target/spring-petclinic-$APP_NAME-$VERSION.jar spring-petclinic-$APP_NAME-$VERSION.jar
   sed -i "s|my-service|$APP_NAME|g" Dockerfile

   az containerapp update \
      --name $APP_NAME \
      --resource-group $RESOURCE_GROUP \
      --source .  \
      --set-env-vars APPLICATIONINSIGHTS_CONNECTION_STRING=$AI_CONNECTIONSTRING APPLICATIONINSIGHTS_CONFIGURATION_CONTENT='{"role": {"name": "visits-service"}}' InstrumentationKey=$AI_CONNECTIONSTRING

   sed -i "s|$APP_NAME|my-service|g" Dockerfile
   rm spring-petclinic-$APP_NAME-$VERSION.jar
   ```
   >This will redeploy all your container apps, after redeploy, double check that you are still able to connect to the database and see data in the apps.

## Summary

In this exercise, you created a database administrator account to manage access to the MySQL Flexible server. You established service connections for the Spring Petclinic microservices, allowing them to securely communicate with the database server. Finally, you updated the applications to leverage passwordless connectivity using Azure SDK, enhancing security and simplifying the authentication process. This comprehensive setup ensures seamless integration between the microservices and the database while adhering to best practices in cloud security.

### You have successfully completed this Lab!
   










