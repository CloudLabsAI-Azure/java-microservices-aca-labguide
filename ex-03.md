# Exercise 3: Create a database administrator account

### Estimated Duration: 60 minutes

## Lab Scenario

Your team is now running a first version of the spring-petclinic microservice application in Azure. However you donâ€™t like the fact that your application secrets live directly in configuration code. You would like to have a better way to protect application secrets like your database connection string . In this lab you will better protect your application secrets.

## Lab Objectives

After you complete this lab, you will be able to:

 - Create a database administrator account
 - Create service connections from the microservices to the database server
 - Update the applications to use passwordless connectivity

## Task 1: Create a database administrator account

1. Navigate back to **Git Bash** terminal, run the following command because You will need to allow the user assigned managed identity access to the database. To configure this, you will need to first make your current logged in user account database administrator. For this to work on a MySQL database you first need an additional managed identity.

   ```
   DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME=uid-dbadmin-petclinic-<inject key="DeploymentID" enableCopy="false" />
   
   ADMIN_IDENTITY_RESOURCE_ID=$(az identity create \
    --name $DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME \
    --resource-group $RESOURCE_GROUP \
    --query id \
    --output tsv)
   ```

1. Now you have to assign this identity to your MySQL server.

   ```
   az mysql flexible-server identity assign \
      --resource-group $RESOURCE_GROUP \
      --server-name $MYSQL_SERVER_NAME \
      --identity    $DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME


   az mysql flexible-server identity list \
      --resource-group $RESOURCE_GROUP \
      --server-name $MYSQL_SERVER_NAME 
   ```

1. Get the current logged in user and object ID by running this command. This will give you the info of the user account you are currently logged in with in the Azure CLI.

   ```
   CURRENT_USER=$(az account show --query user.name --output tsv)
   echo $CURRENT_USER
   CURRENT_USER_OBJECTID=$(az ad signed-in-user show --query id --output tsv)
   echo $CURRENT_USER_OBJECTID
   ```

1. Next you create a database administrator based on your current user account by running the below command block.

   ```
   az mysql flexible-server ad-admin create \
      --resource-group $RESOURCE_GROUP \
      --server-name $MYSQL_SERVER_NAME \
      --object-id $CURRENT_USER_OBJECTID \
      --display-name $CURRENT_USER \
      --identity $DB_ADMIN_USER_ASSIGNED_IDENTITY_NAME

   DB_ID=$(az mysql flexible-server db show \
       --server-name $MYSQL_SERVER_NAME \
       --resource-group $RESOURCE_GROUP \
       -d $DATABASE_NAME \
       --query id \
       -o tsv)
   ```

## Task 2: Create service connections from the microservices to the database server

The apps deployed as the Spring Petclinic microservices will now connect using a service connector to the MySQL Flexible server. A service connector will set up the needed environment variables the service needs to make the connection. You can use the following guidance to create a service connector.

1. For creating a service connector you will need to add the serviceconnector-passwordless extension.

   ```
   az extension add --name serviceconnector-passwordless --upgrade
   ```

1. You will need your subscription ID and resources IDs to create service conections. Run the following commands to get this.

   ```
   SUBID=$(az account show --query id -o tsv)

   CUSTOMERS_ID=$(az containerapp show \
                 --resource-group $RESOURCE_GROUP \
                 --name customers-service \
                 --query id \
                 -o tsv)

    VISITS_ID=$(az containerapp show \
                --resource-group $RESOURCE_GROUP \
                --name visits-service \
                --query id \
                -o tsv)
    
    VETS_ID=$(az containerapp show \
              --resource-group $RESOURCE_GROUP \
              --name vets-service \
              --query id \
              -o tsv)
   ```

1. Create the service connection for the `customers-service`.

   ```
   CLIENT_ID=$(az identity show --resource-group $RESOURCE_GROUP --name $ACA_IDENTITY --query 'clientId' --output tsv)
   echo $CLIENT_ID
   az containerapp connection create mysql-flexible \
      --connection mysql_conn \
      --source-id $CUSTOMERS_ID \
      --target-id $DB_ID \
      --client-type SpringBoot \
      --user-identity client-id=$CLIENT_ID  subs-id=$SUBID mysql-identity-id=$ADMIN_IDENTITY_RESOURCE_ID \
      -c customers-service
   ```

1. Now that you have created the service connection, its time to validate the connection.

   ```
   CUSTOMERS_CONN_ID=$(az containerapp connection list \
                --resource-group $RESOURCE_GROUP \
                --name customers-service \
                --query [].id -o tsv)
   
   az containerapp connection validate \
       --id $CUSTOMERS_CONN_ID
   ```

   >**Note:** The output of this command should show that the connection was made **successful**.

1. In the same way create the service connections for the `vets-service` and `visits-service`. and validate them.

   * vets-service
   
   ```
   az containerapp connection create mysql-flexible \
      --connection mysql_conn \
      --source-id $VETS_ID \
      --target-id $DB_ID \
      --client-type SpringBoot \
      --user-identity client-id=$CLIENT_ID  subs-id=$SUBID mysql-identity-id=$ADMIN_IDENTITY_RESOURCE_ID \
      -c vets-service
   ```
   ```
   VETS_CONN_ID=$(az containerapp connection list \
                --resource-group $RESOURCE_GROUP \
                --name vets-service \
                --query [].id -o tsv)
   
   az containerapp connection validate \
       --id $VETS_CONN_ID
   ```
   * visits-service

   ```
   az containerapp connection create mysql-flexible \
      --connection mysql_conn \
      --source-id $VISITS_ID \
      --target-id $DB_ID \
      --client-type SpringBoot \
      --user-identity client-id=$CLIENT_ID  subs-id=$SUBID mysql-identity-id=$ADMIN_IDENTITY_RESOURCE_ID \
      -c visits-service
   ```
   ```
   VISITS_CONN_ID=$(az containerapp connection list \
                --resource-group $RESOURCE_GROUP \
                --name visits-service \
                --query [].id -o tsv)
   
   az containerapp connection validate \
      --id $VISITS_CONN_ID
   ```

1. In the Azure Portal, navigate to your **customers-service** container app. In the customers-service app, select the **Service Connector** menu item. Notice in this screen you can see the details of your service connector.

## Task 3: Update the applications to use passwordless connectivity

1. You will now need to update the spring-petclinic-customers-service, spring-petclinic-visits-service and spring-petclinic-vets-service to make use of the passwordless capabilities of the Azure SDK.

1. Navigate to `C:\Labfiles\aca\java-microservices-aca-lab-main\src\spring-petclinic-customers-service` and select the `pom.xml` file.

   ![](./media/ex3img1.png)

1. In the file, find **Dependency** block with `mysql-connector-j`, which looks like this:

   ![](./media/ex3img3.png)

1. Now replace the block with the below given content.

   ```
   <dependency>
       <groupId>com.azure.spring</groupId>
       <artifactId>spring-cloud-azure-starter-jdbc-mysql</artifactId>
   </dependency>
   ```

   ![](./media/ex3img2.png)
   
   >**Note:** Make sure you are providing the proper indentations as shown in the screenshot above.

1. Once the modification is done, save the file using **save** option from file menu.

   ![](./media/ex3img7.png)

1. Repeat the steps from 2 to 5 for `spring-petclinic-visits-service` and `spring-petclinic-vets-service`, by navigating to their respective directories as follows:

   |Service Name | File Path |
   |-------------|-----------|
   | visits-service | C:\Labfiles\aca\java-microservices-aca-lab-main\src\spring-petclinic-visits-service\pom.xml |
   | vets service | C:\Labfiles\aca\java-microservices-aca-lab-main\src\spring-petclinic-vets-service\pom.xml |

1. After modifying these, navigate to the **src (1)** folder and select the `pom.xml` **(2)** file.

   ![](./media/ex3img4.png)

1. In this `pom.xml` file, find the `<dependencyManagement><dependencies></dependencies></dependencyManagement>` block and add the new dependency given here.

   ```
   <dependency>
        <groupId>com.azure.spring</groupId>
        <artifactId>spring-cloud-azure-dependencies</artifactId>
        <version>${version.spring.cloud.azure}</version>
        <type>pom</type>
        <scope>import</scope>
   </dependency>
   ```
   ![](./media/ex3img5.png)

1. In the same file also add an additional property between the `<properties></properties>` block.

   ```
   <version.spring.cloud.azure>5.13.0</version.spring.cloud.azure>
   ```

   ![](./media/ex3img6.png)

1. With these changes done. Make sure you save the file using the **save** option from file menu.

   ![](./media/ex3img7.png)

1. Once all the things are done, you have to rebuild the project by running the below commands. Make sure you are in `src` directory.

   ```
   mvn clean package -DskipTests
   ```

1. Once the build is successfull, now update the `customers-service`, `vets-service` and `visits-service` container apps by running the following commands.

   * customers-service

   ```
   cd staging-acr

   export APP_NAME="customers-service"
   cp ../spring-petclinic-$APP_NAME/target/spring-petclinic-$APP_NAME-$VERSION.jar spring-petclinic-$APP_NAME-$VERSION.jar
   sed -i "s|my-service|$APP_NAME|g" Dockerfile

   az containerapp update \
      --name $APP_NAME \
      --resource-group $RESOURCE_GROUP \
      --source .  \
      --set-env-vars APPLICATIONINSIGHTS_CONNECTION_STRING=$AI_CONNECTIONSTRING APPLICATIONINSIGHTS_CONFIGURATION_CONTENT='{"role": {"name": "customers-service"}}' InstrumentationKey=$AI_CONNECTIONSTRING

   sed -i "s|$APP_NAME|my-service|g" Dockerfile
   rm spring-petclinic-$APP_NAME-$VERSION.jar
   ```

   * vets-service

   ```
   export APP_NAME="vets-service"
   cp ../spring-petclinic-$APP_NAME/target/spring-petclinic-$APP_NAME-$VERSION.jar spring-petclinic-$APP_NAME-$VERSION.jar
   sed -i "s|my-service|$APP_NAME|g" Dockerfile
   
   az containerapp update \
      --name $APP_NAME \
      --resource-group $RESOURCE_GROUP \
      --source .  \
      --set-env-vars APPLICATIONINSIGHTS_CONNECTION_STRING=$AI_CONNECTIONSTRING APPLICATIONINSIGHTS_CONFIGURATION_CONTENT='{"role": {"name": "vets-service"}}' InstrumentationKey=$AI_CONNECTIONSTRING

   sed -i "s|$APP_NAME|my-service|g" Dockerfile
   rm spring-petclinic-$APP_NAME-$VERSION.jar
   ```

   * visits-service

   ```
   export APP_NAME="visits-service"
   cp ../spring-petclinic-$APP_NAME/target/spring-petclinic-$APP_NAME-$VERSION.jar spring-petclinic-$APP_NAME-$VERSION.jar
   sed -i "s|my-service|$APP_NAME|g" Dockerfile

   az containerapp update \
      --name $APP_NAME \
      --resource-group $RESOURCE_GROUP \
      --source .  \
      --set-env-vars APPLICATIONINSIGHTS_CONNECTION_STRING=$AI_CONNECTIONSTRING APPLICATIONINSIGHTS_CONFIGURATION_CONTENT='{"role": {"name": "visits-service"}}' InstrumentationKey=$AI_CONNECTIONSTRING

   sed -i "s|$APP_NAME|my-service|g" Dockerfile
   rm spring-petclinic-$APP_NAME-$VERSION.jar
   ```
   










